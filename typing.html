<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: monospace;
            background-color: #1a1a2e; /* å®‡å®™ã£ã½ã„èƒŒæ™¯ */
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        #gameContainer {
            width: 800px;
            max-width: 90%;
            padding: 20px;
            background-color: #2c2c54;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒãƒªã‚¢ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #statusArea {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        .bar-container {
            width: 48%;
            background-color: #4a4e69;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #c9cba3;
        }

        #playerHealthBar, #shieldStrengthBar {
            height: 25px;
            transition: width 0.3s, background-color 0.3s;
            text-align: center;
            line-height: 25px;
            color: black;
            font-weight: bold;
            font-size: 0.9em;
        }

        #playerHealthBar { background-color: #e76f51; } /* èµ¤ç³» */
        #shieldStrengthBar { background-color: #2a9d8f; } /* ç·‘ç³» */

        /* ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒªã‚¢ */
        #typingArea {
            background-color: #0d0d1b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        #targetText {
            font-size: 1.8em;
            letter-spacing: 1px;
            white-space: pre; /* ç©ºç™½ã‚’ä¿æŒ */
            height: 35px;
            margin-bottom: 15px;
        }

        .correct { color: #a7c957; } /* æ­£ã—ã„æ–‡å­— */
        .current { background-color: rgba(255, 255, 255, 0.2); } /* ç¾åœ¨å…¥åŠ›ä¸­ã®æ–‡å­— */
        .incorrect { color: #e76f51; text-decoration: underline wavy #e76f51; } /* é–“é•ã£ãŸæ–‡å­— */

        #textInput {
            width: 100%;
            padding: 10px;
            font-size: 1.2em;
            border: 2px solid #555;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #3e3e60;
            color: white;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ãƒœã‚¿ãƒ³ */
        #messageArea {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2em;
            color: #ffcc00;
        }

        #startButton {
            padding: 10px 20px;
            font-size: 1.2em;
            background-color: #ffcc00;
            color: #333;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #startButton:hover { background-color: #e6b800; }
        #startButton:disabled { background-color: #888; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>ğŸ›¡ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹ ğŸ›¡ï¸</h1>
        
        <div id="messageArea">Press START to defend your base!</div>

        <div id="statusArea">
            <div>
                HP: <span id="playerHealthValue">100</span>%
                <div class="bar-container">
                    <div id="playerHealthBar" style="width: 100%;">HP 100%</div>
                </div>
            </div>
            <div>
                ãƒãƒªã‚¢å¼·åº¦: <span id="shieldStrengthValue">0</span>%
                <div class="bar-container">
                    <div id="shieldStrengthBar" style="width: 0%;">SHIELD 0%</div>
                </div>
            </div>
        </div>

        <div id="typingArea">
            <div id="targetText"></div>
            <input type="text" id="textInput" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ—ã—ã¦ãã ã•ã„..." autofocus disabled>
        </div>

        <button id="startButton">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>

    <script>
        // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
        const MAX_HP = 100;
        const MAX_SHIELD_STRENGTH = 100;
        const GAME_DURATION = 60; // åˆ¶é™æ™‚é–“ (ç§’)
        const ENEMY_ATTACK_INTERVAL = 3000; // æ•µã®æ”»æ’ƒé–“éš” (ãƒŸãƒªç§’)

        // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°èª²é¡Œã®ãƒªã‚¹ãƒˆ
        const TYPING_CHALLENGES = [
            "the quick brown fox jumps over the lazy dog",
            "javascript is fun and challenging to learn",
            "shield up activate defense matrix now",
            "accurate and fast typing is crucial for survival",
            "always be ready for the next enemy attack",
            "coding makes you a powerful wizard of the screen",
            "do not panic and keep your focus on the text",
            "resilience comes from consistent practice",
        ];

        // --- ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ ---
        let health = MAX_HP;
        let shieldStrength = 0;
        let gameActive = false;
        let currentTargetText = '';
        let typedCharacters = '';
        let startTime;
        let gameTimer;
        let attackTimer;
        let totalTypedChars = 0;
        let correctTypedChars = 0;

        // --- DOMè¦ç´  ---
        const messageArea = document.getElementById('messageArea');
        const startButton = document.getElementById('startButton');
        const playerHealthBar = document.getElementById('playerHealthBar');
        const playerHealthValue = document.getElementById('playerHealthValue');
        const shieldStrengthBar = document.getElementById('shieldStrengthBar');
        const shieldStrengthValue = document.getElementById('shieldStrengthValue');
        const targetTextElement = document.getElementById('targetText');
        const textInput = document.getElementById('textInput');

        // --- é–¢æ•°å®šç¾© ---

        /**
         * æ–°ã—ã„ã‚¿ã‚¤ãƒ”ãƒ³ã‚°èª²é¡Œã‚’è¨­å®šã™ã‚‹
         */
        function loadNewChallenge() {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«èª²é¡Œã‚’é¸æŠ
            const randomIndex = Math.floor(Math.random() * TYPING_CHALLENGES.length);
            currentTargetText = TYPING_CHALLENGES[randomIndex];
            typedCharacters = '';
            
            // ç”»é¢è¡¨ç¤ºã‚’æ›´æ–°
            renderTargetText();
            textInput.value = '';
        }

        /**
         * ç”»é¢ä¸Šã®èª²é¡Œãƒ†ã‚­ã‚¹ãƒˆã®è‰²åˆ†ã‘ã‚’æ›´æ–°ã™ã‚‹
         */
        function renderTargetText() {
            let html = '';
            for (let i = 0; i < currentTargetText.length; i++) {
                let char = currentTargetText[i];
                let className = '';

                if (i < typedCharacters.length) {
                    // å…¥åŠ›æ¸ˆã¿
                    if (typedCharacters[i] === char) {
                        className = 'correct';
                    } else {
                        className = 'incorrect';
                    }
                } else if (i === typedCharacters.length) {
                    // æ¬¡ã«å…¥åŠ›ã™ã¹ãæ–‡å­—
                    className = 'current';
                }

                html += `<span class="${className}">${char}</span>`;
            }
            targetTextElement.innerHTML = html;
        }

        /**
         * ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®æ­£ç¢ºã•ã¨é€Ÿåº¦ã«åŸºã¥ã„ã¦ãƒãƒªã‚¢å¼·åº¦ã‚’è¨ˆç®—ã™ã‚‹
         * (0% - 100%)
         */
        function updateShieldStrength() {
            const currentTime = Date.now();
            const elapsedTimeSeconds = (currentTime - startTime) / 1000;

            if (totalTypedChars === 0 || elapsedTimeSeconds === 0) {
                shieldStrength = 0;
            } else {
                // 1. æ­£ç¢ºã• (0.0 - 1.0)
                const accuracy = correctTypedChars / totalTypedChars;

                // 2. é€Ÿåº¦ (WPMã®ç°¡æ˜“ç‰ˆ: 1åˆ†ã‚ãŸã‚Šã®æ­£ã—ãæ‰“ã£ãŸæ–‡å­—æ•°)
                // 60ç§’ã§100æ–‡å­— (WPM 20) ã‚’æ‰“ã¦ã‚Œã°æº€ç‚¹ã¨ä»®å®š
                const speedFactor = (correctTypedChars / elapsedTimeSeconds) * 60; // CPM (Characters Per Minute)
                
                // é€Ÿåº¦ãƒœãƒ¼ãƒŠã‚¹: é€Ÿåº¦ã‚’MAX_SHIELD_STRENGTHã«æ­£è¦åŒ– (ä¾‹: 100CPMã§æº€ç‚¹)
                const MAX_CPM_FOR_BONUS = 150; 
                let normalizedSpeed = Math.min(speedFactor, MAX_CPM_FOR_BONUS) / MAX_CPM_FOR_BONUS;

                // 3. ãƒãƒªã‚¢å¼·åº¦ã®è¨ˆç®—
                // æ­£ç¢ºã•ã®æ¯”é‡ã‚’é«˜ãã€é€Ÿåº¦ã‚’ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦åŠ ç®—
                // strength = (accuracy * 70%) + (normalizedSpeed * 30%) ã‚’æœ€å¤§100ã«
                let calculatedStrength = (accuracy * 0.7 + normalizedSpeed * 0.3) * 100;
                
                // æœ€çµ‚å¼·åº¦ã‚’0-100%ã«åˆ¶é™
                shieldStrength = Math.min(Math.round(calculatedStrength), MAX_SHIELD_STRENGTH);
            }

            // UIã‚’æ›´æ–°
            shieldStrengthValue.textContent = `${shieldStrength}`;
            shieldStrengthBar.style.width = `${shieldStrength}%`;
            
            // å¼·åº¦ã«å¿œã˜ã¦è‰²ã‚’å¤‰ãˆã‚‹ (é«˜ã„ã»ã©é’ã)
            const r = Math.round(255 - (shieldStrength * 2.55)); // 100%ã§0
            const g = Math.round(150 + (shieldStrength * 1));
            const b = 255;
            shieldStrengthBar.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            shieldStrengthBar.textContent = `SHIELD ${shieldStrength}%`;
        }

        /**
         * æ•µã®æ”»æ’ƒå‡¦ç†
         */
        function enemyAttack() {
            if (!gameActive) return;

            // ãƒãƒªã‚¢å¼·åº¦ã«å¿œã˜ã¦ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è¨ˆç®—
            const BASE_DAMAGE = 10;
            // è»½æ¸›ç‡: ãƒãƒªã‚¢å¼·åº¦ãŒé«˜ã„ã»ã©ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›
            const damageReduction = shieldStrength / MAX_SHIELD_STRENGTH; // 0.0 ~ 1.0
            const actualDamage = Math.max(0, BASE_DAMAGE * (1 - damageReduction));

            // HPã‚’æ›´æ–°
            health -= actualDamage;
            if (health < 0) health = 0;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (actualDamage > 0) {
                messageArea.textContent = `ğŸ’¥ æ•µãŒæ”»æ’ƒï¼${actualDamage.toFixed(1)}ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚`;
            } else {
                messageArea.textContent = `ğŸ›¡ï¸ æ”»æ’ƒã‚’é˜²ã„ã ï¼ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—ã€‚`;
            }

            // HPã®UIã‚’æ›´æ–°
            updateHealthDisplay();

            if (health <= 0) {
                endGame(false); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
            }
        }

        /**
         * HPã®UIã‚’æ›´æ–°
         */
        function updateHealthDisplay() {
            playerHealthValue.textContent = `${Math.round(health)}`;
            playerHealthBar.style.width = `${health}%`;
            playerHealthBar.textContent = `HP ${Math.round(health)}%`;
            
            // HPãŒä½ã„ã¨èµ¤ãã™ã‚‹
            if (health < 30) {
                playerHealthBar.style.backgroundColor = '#f72585';
            } else if (health < 60) {
                playerHealthBar.style.backgroundColor = '#ffc300';
            } else {
                playerHealthBar.style.backgroundColor = '#2a9d8f';
            }
        }

        /**
         * ã‚²ãƒ¼ãƒ ã®çµŒéæ™‚é–“ã‚’æ›´æ–°ã—ã€çµ‚äº†ã‚’ãƒã‚§ãƒƒã‚¯
         */
        function updateGameTime() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const remainingTime = GAME_DURATION - elapsedTime;

            if (remainingTime <= 0) {
                endGame(true); // å‹åˆ©
                return;
            }

            messageArea.textContent = `â³ æ®‹ã‚Šæ™‚é–“: ${remainingTime.toFixed(1)}ç§’`;
        }


        /**
         * ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å…¥åŠ›å‡¦ç†
         */
        function handleInput(event) {
            if (!gameActive) return;

            const input = event.target.value;
            typedCharacters = input;

            // 1æ–‡å­—ã”ã¨ã®æ­£èª¤ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
            const lastTypedChar = input.slice(-1);
            const targetChar = currentTargetText[input.length - 1];

            if (input.length > typedCharacters.length) {
                totalTypedChars++;
                if (lastTypedChar === targetChar) {
                    correctTypedChars++;
                }
            }
            
            // èª²é¡Œã®å®Œäº†ãƒã‚§ãƒƒã‚¯
            if (typedCharacters.length === currentTargetText.length) {
                // å®Œå…¨ã«æ­£ã—ãæ‰“ã¦ã¦ã„ã‚Œã°ã€ãƒœãƒ¼ãƒŠã‚¹ã¨ã—ã¦å³åº§ã«æ–°ã—ã„èª²é¡Œã¸
                if (typedCharacters === currentTargetText) {
                    loadNewChallenge();
                } else {
                    // é–“é•ã£ã¦ã„ã‚‹å ´åˆã¯ã€ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§ä¿®æ­£ã•ã›ã‚‹
                    // ã“ã“ã§ã¯å‡¦ç†ãªã—
                }
            }

            // ãƒãƒªã‚¢å¼·åº¦ã‚’å³åº§ã«æ›´æ–°
            updateShieldStrength();
            renderTargetText();
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
         */
        function startGame() {
            gameActive = true;
            health = MAX_HP;
            shieldStrength = 0;
            totalTypedChars = 0;
            correctTypedChars = 0;
            startTime = Date.now();
            
            startButton.disabled = true;
            textInput.disabled = false;
            textInput.focus();

            loadNewChallenge();
            updateShieldStrength();
            updateHealthDisplay();
            
            // ã‚¿ã‚¤ãƒãƒ¼ã¨æ”»æ’ƒã®é–‹å§‹
            gameTimer = setInterval(updateGameTime, 100);
            attackTimer = setInterval(enemyAttack, ENEMY_ATTACK_INTERVAL);
        }

        /**
         * ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹
         */
        function endGame(isWin) {
            gameActive = false;
            clearInterval(gameTimer);
            clearInterval(attackTimer);
            
            textInput.disabled = true;
            startButton.disabled = false;
            startButton.textContent = 'ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤';

            if (isWin) {
                messageArea.innerHTML = 'ğŸ‰ **VICTORY!** åŸºåœ°ã‚’é˜²è¡›ã—ãã£ãŸï¼ ğŸ‰';
            } else {
                messageArea.innerHTML = 'ğŸ’€ **DEFEAT...** HPãŒå°½ããŸ ğŸ’€';
            }
        }

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        startButton.addEventListener('click', startGame);
        textInput.addEventListener('input', handleInput);

        // åˆæœŸåŒ–æ™‚ã®UIè¡¨ç¤º
        targetTextElement.textContent = "Press START to begin the defense.";
        updateHealthDisplay();
    </script>
</body>
</html>
