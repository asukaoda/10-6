<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ãƒ‘ãƒ³ãƒ‡ãƒŸãƒƒã‚¯ãƒ»ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#22c55e; --danger:#ef4444; --mut:#f59e0b;
      --glass: rgba(255,255,255,0.03);
      font-family: "Helvetica Neue", Arial, sans-serif;
    }
    body{ margin:0; min-height:100vh; background:linear-gradient(180deg,#071026 0%, #052034 100%); color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:24px; }
    .wrap{ width:980px; max-width:100%; background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border-radius:12px; box-shadow: 0 10px 30px rgba(2,6,23,0.7); padding:20px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1{ margin:0; font-size:20px; letter-spacing:0.6px; }
    .topline{ font-size:13px; color:#9fb3d1; }
    .main{ display:grid; grid-template-columns: 360px 1fr; gap:18px; margin-top:18px; }
    .card{ background:var(--card); border-radius:10px; padding:14px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    #stats p{ margin:8px 0; font-size:14px; }
    .stat-row{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .big{ font-weight:700; font-size:18px; color:#fff; }
    .progress{ width:100%; height:12px; background:var(--glass); border-radius:8px; overflow:hidden; }
    .bar{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent), #10b981); transition:width 0.5s ease; }
    .bar-vax{ background:linear-gradient(90deg,#60a5fa,#3b82f6); }
    .bar-danger{ background:linear-gradient(90deg,#fb7185,#ef4444); }
    .actions{ display:flex; flex-direction:column; gap:8px; }
    .actions button{ padding:10px 12px; border-radius:8px; border:0; background:#122433; color:#dff4e6; font-weight:600; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
    .actions button:disabled{ opacity:0.45; cursor:not-allowed; }
    .cost{ font-size:13px; color:#bcd8c3; }
    .log{ max-height:280px; overflow:auto; font-size:13px; color:#cfe8ff; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); padding:8px; border-radius:8px; }
    footer{ margin-top:14px; display:flex; justify-content:space-between; align-items:center; color:#9fb3d1; font-size:13px; }
    .center{ text-align:center; }
    .small{ font-size:12px; color:#9fb3d1; }
    .status-pill{ padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.03); font-weight:700; }
    .flex{ display:flex; gap:8px; align-items:center; }
    @media(max-width:880px){ .main{ grid-template-columns: 1fr; } .wrap{ padding:12px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸŒ ãƒ‘ãƒ³ãƒ‡ãƒŸãƒƒã‚¯ãƒ»ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒ€ãƒ¼</h1>
        <div class="topline">ã‚ãªãŸã¯å›½éš›é˜²ç–«ãƒãƒ¼ãƒ ã®å¸ä»¤å®˜ã€‚ä¸–ç•Œã‚’å®ˆã£ã¦æ„ŸæŸ“ã‚’åæŸã•ã›ã‚ˆã†ã€‚</div>
      </div>
      <div class="flex">
        <div class="small">ã‚²ãƒ¼ãƒ é€Ÿåº¦ï¼š<span id="speedLabel">æ¨™æº–</span></div>
        <select id="speed" title="ã‚²ãƒ¼ãƒ é€Ÿåº¦">
          <option value="1000">é…ã„</option>
          <option value="700" selected>æ¨™æº–</option>
          <option value="350">é€Ÿã„</option>
        </select>
      </div>
    </header>

    <div class="main">
      <!-- å·¦ï¼šæ“ä½œï¼†ãƒ­ã‚° -->
      <div>
        <div class="card" id="stats">
          <p><span class="small">ä¸–ç•Œäººå£</span> <span class="big" id="worldPop">7,800,000,000</span></p>
          <div class="stat-row"><div>æ„ŸæŸ“è€…</div><div class="big" id="infected">100,000</div></div>
          <div class="stat-row"><div>æ²»ç™’è€…</div><div class="big" id="recovered">0</div></div>
          <div class="stat-row"><div>æ­»äº¡è€…</div><div class="big" id="dead">0</div></div>
          <p style="margin-top:8px;"><span class="small">ãƒ¯ã‚¯ãƒãƒ³é€²è¡Œç‡</span></p>
          <div class="progress" style="margin-bottom:8px;"><div id="vaxBar" class="bar bar-vax" style="width:0%"></div></div>
          <div class="stat-row"><div>è³‡æº</div><div class="big" id="resources">15</div></div>
          <div style="margin-top:10px;">
            <div class="small">æ„ŸæŸ“ç‡ã®ç›®å®‰ï¼š <span id="spreadLabel">ã‚„ã‚„æ‹¡å¤§ä¸­</span></div>
            <div class="progress" style="margin-top:6px;"><div id="spreadBar" class="bar bar-danger" style="width:10%"></div></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="actions">
            <button id="btnResearch"><span>ğŸ§ª ãƒ¯ã‚¯ãƒãƒ³ç ”ç©¶</span><span class="cost">Cost 10</span></button>
            <button id="btnLockdown"><span>ğŸš« ãƒ­ãƒƒã‚¯ãƒ€ã‚¦ãƒ³ï¼ˆå›½å¢ƒå°é–ï¼‰</span><span class="cost">Cost 8</span></button>
            <button id="btnMedical"><span>ğŸ¥ åŒ»ç™‚æ”¯æ´ï¼ˆç—…åºŠè¿½åŠ ï¼‰</span><span class="cost">12</span></button>
            <button id="btnInfo"><span>ğŸ“¢ æƒ…å ±ç™ºä¿¡ï¼ˆå•“è’™/ãƒ‡ãƒå¯¾ç­–ï¼‰</span><span class="cost">6</span></button>
          </div>
          <div style="margin-top:10px;" class="small">â€» å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯æ•°ç§’ã®åŠ¹æœæŒç¶šã¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚ã‚Šã€‚</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="log" id="log"></div>
        </div>
      </div>

      <!-- å³ï¼šã‚²ãƒ¼ãƒ é ˜åŸŸï¼ˆèª¬æ˜ãƒ»å¤§ãã‚è¡¨ç¤ºï¼‰ -->
      <div>
        <div class="card center">
          <h2 id="stageTitle">ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ»ã‚¢ã‚¦ãƒˆãƒ–ãƒ¬ã‚¤ã‚¯</h2>
          <p class="small" style="max-width:720px; margin:0 auto 12px;">ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç§’ã”ã¨ã«é€²è¡Œã—ã¾ã™ã€‚è³‡æºã‚’ä½¿ã£ã¦å¯¾ç­–ã‚’æ‰“ã¡ã€ãƒ¯ã‚¯ãƒãƒ³ã‚’å®Œæˆã•ã›ã¦æ„ŸæŸ“ã‚’åæŸã•ã›ã¾ã—ã‚‡ã†ã€‚</p>

          <div style="display:flex; gap:10px; justify-content:center; margin:8px 0;">
            <div style="text-align:left;">
              <div class="small">æ„ŸæŸ“ç‡ï¼ˆRç›¸å½“ï¼‰</div>
              <div class="big" id="spreadVal">1.03</div>
            </div>
            <div style="text-align:left;">
              <div class="small">è‡´æ­»ç‡</div>
              <div class="big" id="deathVal">0.10%</div>
            </div>
            <div style="text-align:left;">
              <div class="small">ãƒ¯ã‚¯ãƒãƒ³é€²è¡Œé€Ÿåº¦</div>
              <div class="big" id="researchVal">0.5%/tick</div>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:12px; justify-content:center;">
            <button id="btnPause">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
            <button id="btnReset">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px;">
          <div class="small">ãƒ’ãƒ³ãƒˆï¼š</div>
          <ul class="small" style="margin:8px 0 0 18px; line-height:1.6;">
            <li>ãƒ¯ã‚¯ãƒãƒ³ã¯å®Œæˆã™ã‚‹ã¨æ„ŸæŸ“æ•°ã‚’åŠ‡çš„ã«æ¸›ã‚‰ã™ã€‚</li>
            <li>ãƒ­ãƒƒã‚¯ãƒ€ã‚¦ãƒ³ã¯æ„ŸæŸ“æ‹¡å¤§ã‚’æŠ‘ãˆã‚‹ãŒè³‡æºæ¶ˆè²»ã¨åç™ºãŒèµ·ãã‚‹ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆã§è¡¨ç¾ï¼‰ã€‚</li>
            <li>åŒ»ç™‚æ”¯æ´ã§æ­»äº¡ç‡ã‚’ä¸‹ã’ã€æ²»ç™’ç‡ã‚’ä¸Šã’ã‚‰ã‚Œã¾ã™ã€‚</li>
            <li>è³‡æºã¯æ™‚é–“ã§å›å¾©ã—ã¾ã™ã€‚ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã¯è‰¯ã„ã‚‚ã®ã‚‚æ‚ªã„ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚</li>
          </ul>
        </div>

      </div>
    </div>

    <footer>
      <div class="small">è£½ä½œï¼šHTML/CSS/JS ãƒ‡ãƒ¢ / ã‚¯ãƒªãƒƒã‚¯ã§å¯¾ç­–ã‚’å®Ÿè¡Œ</div>
      <div><span class="status-pill" id="gameStatus">é€²è¡Œä¸­</span></div>
    </footer>
  </div>

  <script>
    // ---------- åˆæœŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ----------
    const worldPop = 7800000000; // ä¸–ç•Œäººå£ï¼ˆå›ºå®šè¡¨ç¤ºï¼‰
    let infected = 100000;       // ç¾åœ¨æ„ŸæŸ“è€…æ•°
    let recovered = 0;
    let dead = 0;
    let vaccineProgress = 0;     // 0..100
    let resources = 15;

    // å‹•çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆã‚²ãƒ¼ãƒ çš„ï¼‰
    let spreadRate = 1.03;       // æ„ŸæŸ“è€…ãŒã“ã®å€ç‡ã§å¢—ãˆã‚‹ï¼ˆ1.00 = åœæ»ï¼‰
    let baseHealRate = 0.01;     // æ„ŸæŸ“è€…ã®ã†ã¡å›å¾©ã™ã‚‹å‰²åˆ/ãƒ†ã‚£ãƒƒã‚¯
    let baseDeathRate = 0.001;   // æ„ŸæŸ“è€…ã®ã†ã¡æ­»äº¡ã™ã‚‹å‰²åˆ/ãƒ†ã‚£ãƒƒã‚¯
    let researchRate = 0.5;      // ãƒ¯ã‚¯ãƒãƒ³é€²è¡Œã®åŸºæœ¬é€Ÿåº¦ï¼ˆ%/tickï¼‰
    let tickMs = 700;            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚£ãƒƒã‚¯é–“éš”ï¼ˆmsï¼‰
    let running = true;
    let gameOver = false;

    // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒ»ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
    const cooldowns = {
      research: 0,
      lockdown: 0,
      medical: 0,
      info: 0
    };

    // åŠ¹æœæŒç¶šã‚«ã‚¦ãƒ³ã‚¿ï¼ˆãƒ†ã‚£ãƒƒã‚¯æ•°ï¼‰
    let effects = {
      lockdown: 0, // æ™‚é–“ä¸­ spreadRateæ¸›å°‘
      medical: 0,  // æ­»äº¡ç‡æ¸›å°‘ãƒ»æ²»ç™’ç‡å¢—åŠ 
      info: 0      // ãƒ‡ãƒæŠ‘åˆ¶ = ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åŠ¹æœUP
    };

    // DOM
    const el = id => document.getElementById(id);
    const logEl = el('log');
    const infectedEl = el('infected');
    const recoveredEl = el('recovered');
    const deadEl = el('dead');
    const vaxBar = el('vaxBar');
    const resourcesEl = el('resources');
    const spreadBar = el('spreadBar');
    const spreadLabel = el('spreadLabel');
    const spreadVal = el('spreadVal');
    const deathVal = el('deathVal');
    const researchVal = el('researchVal');
    const btnResearch = el('btnResearch');
    const btnLockdown = el('btnLockdown');
    const btnMedical = el('btnMedical');
    const btnInfo = el('btnInfo');
    const btnPause = el('btnPause');
    const btnReset = el('btnReset');
    const speedSelect = el('speed');
    const speedLabel = el('speedLabel');
    const gameStatus = el('gameStatus');
    const worldPopEl = el('worldPop');

    worldPopEl.textContent = worldPop.toLocaleString();

    // åˆæœŸãƒ­ã‚°
    addLog("ã‚²ãƒ¼ãƒ é–‹å§‹ã€‚åˆæœŸæ„ŸæŸ“è€…ï¼š" + infected.toLocaleString());

    // ---------- UI æ›´æ–°é–¢æ•° ----------
    function updateUI(){
      infectedEl.textContent = Math.floor(infected).toLocaleString();
      recoveredEl.textContent = Math.floor(recovered).toLocaleString();
      deadEl.textContent = Math.floor(dead).toLocaleString();
      resourcesEl.textContent = Math.floor(resources);
      vaxBar.style.width = vaccineProgress.toFixed(1) + "%";
      spreadBar.style.width = Math.min(100, (spreadRate - 0.9) * 80) + "%"; // è¦–è¦šåŒ–
      spreadVal.textContent = spreadRate.toFixed(3);
      deathVal.textContent = (baseDeathRate * 100).toFixed(2) + "%";
      researchVal.textContent = researchRate.toFixed(2) + "%/tick";
      // ãƒœã‚¿ãƒ³ enabled/disabled
      btnResearch.disabled = (resources < 10) || cooldowns.research > 0 || gameOver;
      btnLockdown.disabled = (resources < 8) || cooldowns.lockdown > 0 || gameOver;
      btnMedical.disabled = (resources < 12) || cooldowns.medical > 0 || gameOver;
      btnInfo.disabled = (resources < 6) || cooldowns.info > 0 || gameOver;
      // cooldownè¡¨ç¤º
      btnResearch.querySelector('.cost').textContent = cooldowns.research>0 ? `(${cooldowns.research})` : 'Cost 10';
      btnLockdown.querySelector('.cost').textContent = cooldowns.lockdown>0 ? `(${cooldowns.lockdown})` : 'Cost 8';
      btnMedical.querySelector('.cost').textContent = cooldowns.medical>0 ? `(${cooldowns.medical})` : 'Cost 12';
      btnInfo.querySelector('.cost').textContent = cooldowns.info>0 ? `(${cooldowns.info})` : 'Cost 6';
      gameStatus.textContent = gameOver ? 'ã‚²ãƒ¼ãƒ çµ‚äº†' : running ? 'é€²è¡Œä¸­' : 'åœæ­¢ä¸­';
    }

    // ---------- ãƒ­ã‚° ----------
    function addLog(msg){
      const time = new Date().toLocaleTimeString();
      logEl.innerHTML = `<div>[${time}] ${escapeHtml(msg)}</div>` + logEl.innerHTML;
    }
    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // ---------- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œï¼‰ ----------
    btnResearch.addEventListener('click', ()=> {
      if(resources < 10 || cooldowns.research>0 || gameOver) return;
      resources -= 10;
      cooldowns.research = 6; // 6 ticks cooldown
      // immediate boost to researchRate for a while
      researchRate += 1.5; // +1.5%/tick temporary
      effects.researchBoost = 8; // ticks
      addLog("ãƒ¯ã‚¯ãƒãƒ³ç ”ç©¶ã«è³‡æºã‚’æŠ•å…¥ã€‚ç ”ç©¶é€Ÿåº¦ãŒä¸Šæ˜‡ï¼");
      updateUI();
    });

    btnLockdown.addEventListener('click', ()=> {
      if(resources < 8 || cooldowns.lockdown>0 || gameOver) return;
      resources -= 8;
      cooldowns.lockdown = 10;
      effects.lockdown = 10; // ticks with effect
      // lower spreadRate multiplicatively
      spreadRate *= 0.85;
      addLog("å›½å¢ƒå°é–ã‚’å®Ÿæ–½ã€‚æ„ŸæŸ“æ‹¡å¤§ãŒéˆåŒ–ã—ã¾ã™ï¼ˆçŸ­æ™‚é–“ï¼‰ã€‚");
      updateUI();
    });

    btnMedical.addEventListener('click', ()=> {
      if(resources < 12 || cooldowns.medical>0 || gameOver) return;
      resources -= 12;
      cooldowns.medical = 12;
      effects.medical = 12;
      // immediate better treatment
      baseDeathRate *= 0.7; // reduce death rate by 30%
      baseHealRate *= 1.4;  // increase heal rate by 40%
      addLog("åŒ»ç™‚æ”¯æ´ã‚’å±•é–‹ã€‚æ­»äº¡ç‡ãƒ€ã‚¦ãƒ³ã€å›å¾©ç‡ã‚¢ãƒƒãƒ—ï¼ˆçŸ­æ™‚é–“ï¼‰ã€‚");
      updateUI();
    });

    btnInfo.addEventListener('click', ()=> {
      if(resources < 6 || cooldowns.info>0 || gameOver) return;
      resources -= 6;
      cooldowns.info = 8;
      effects.info = 8;
      // improve action efficiency and reduce chance of 'deception' events
      addLog("æƒ…å ±ç™ºä¿¡ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã‚’é–‹å§‹ã€‚å¸‚æ°‘ã®å”åŠ›ãŒå¾—ã‚‰ã‚Œã‚„ã™ããªã‚Šã¾ã™ã€‚");
      updateUI();
    });

    // Pause / Reset
    btnPause.addEventListener('click', ()=> {
      running = !running;
      btnPause.textContent = running ? 'â¸ï¸ ä¸€æ™‚åœæ­¢' : 'â–¶ï¸ å†é–‹';
      updateUI();
    });
    btnReset.addEventListener('click', ()=> {
      if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®é€²è¡Œã¯å¤±ã‚ã‚Œã¾ã™ã€‚")) init();
    });

    // Speed control
    speedSelect.addEventListener('change', ()=> {
      tickMs = Number(speedSelect.value);
      speedLabel.textContent = tickMs>=900 ? 'é…ã„' : tickMs>=500 ? 'æ¨™æº–' : 'é€Ÿã„';
      restartTicker();
    });

    // ---------- ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚£ãƒƒã‚¯ ----------
    let ticker = null;
    function tick(){
      if(!running || gameOver) return;

      // 1) è³‡æºå›å¾©ï¼ˆå°‘é‡ï¼‰
      resources += 0.6; // æ¯tickå›å¾©
      // 2) ç ”ç©¶ã®è‡ªå‹•é€²è¡Œï¼ˆç ”ç©¶Rateï¼‰
      vaccineProgress += researchRate;
      if(vaccineProgress > 100) vaccineProgress = 100;

      // 3) æ„ŸæŸ“ã®å¢—æ¸›
      // æ„ŸæŸ“ã®å¢—åŠ ã¯ç¾åœ¨æ„ŸæŸ“è€… * (spreadRate - 1) ã ãŒæŠ‘åˆ¶ã‚„ãƒ¯ã‚¯ãƒãƒ³åŠ¹æœã€ä¸Šé™ã‚‚è€ƒæ…®
      const susceptible = Math.max(0, worldPop - infected - recovered - dead);
      // new infections this tick (simplified)
      const potentialNew = infected * (spreadRate - 1.0);
      // scale with susceptible fraction:
      const newInfections = Math.min(susceptible, Math.max(0, potentialNew));
      infected += newInfections;

      // recoveries and deaths:
      const recoveries = infected * baseHealRate;
      const deaths = infected * baseDeathRate;
      recovered += recoveries;
      dead += deaths;
      infected = Math.max(0, infected - recoveries - deaths);

      // 4) ãƒ¯ã‚¯ãƒãƒ³å®Œæˆæ™‚ã®åŠ¹æœï¼ˆå®Œäº†ã—ãŸç¬é–“ã«å¤§ããªåŠ¹æœï¼‰
      if(vaccineProgress >= 100 && !gameOver){
        // ãƒ¯ã‚¯ãƒãƒ³å®Œæˆã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ1å›ï¼‰
        addLog("ğŸ‰ ãƒ¯ã‚¯ãƒãƒ³å®Œæˆï¼ä¸–ç•Œçš„ãªæ¥ç¨®ãŒå§‹ã¾ã‚Šæ„ŸæŸ“ãŒæ€¥é€Ÿã«åæŸã—ã¾ã™ã€‚");
        // apply big positive effects
        spreadRate *= 0.5;
        baseHealRate *= 2.5;
        baseDeathRate *= 0.4;
        // slowly reduce infected each tick via an emergency campaign: handle by current dynamics
        vaccineProgress = 100; // clamp
        // To avoid repeating, set vaccineProgress to 100 and set a flag:
        vaccineUsed = true;
      }

      // 5) ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä½ç¢ºç‡ï¼‰
      if(Math.random() < 0.12){ // 12% chance each tick
        triggerEvent();
      }

      // 6) Effects duration handling (decrement and revert when expire)
      handleEffects();

      // 7) cooldown decrement
      for(const k in cooldowns) if(cooldowns[k] > 0) cooldowns[k]--;

      // 8) spreadRate natural drift (slight) - prevents stuck at exact value
      spreadRate = Math.max(0.85, Math.min(1.6, spreadRate * (1 + (Math.random()-0.5)*0.01)));

      // 9) clamp numbers and check end condition
      clampNumbers();

      updateUI();
      checkWinLose();
    }

    let vaccineUsed = false;

    function clampNumbers(){
      // ensure not exceeding worldPop
      const total = infected + recovered + dead;
      if(total > worldPop){
        const overflow = total - worldPop;
        // reduce recovered proportionally
        recovered -= overflow;
        if(recovered < 0) recovered = 0;
      }
      // floor small decimals for UI clarity (but keep floats for simulation)
      infected = Math.max(0, infected);
      recovered = Math.max(0, recovered);
      dead = Math.max(0, dead);
      resources = Math.max(0, resources);
    }

    // ---------- ãƒ©ãƒ³ãƒ€ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ ----------
    function triggerEvent(){
      const r = Math.random();
      // if info effect active, reduce chance of negative events
      const infoActive = effects.info > 0;
      if(r < 0.12 && !infoActive){ // small chance of bad mutation event
        // mutation: increase spreadRate moderately
        spreadRate *= 1.18;
        addLog("âš ï¸ å¤‰ç•°æ ªãŒç™ºç”Ÿï¼æ„ŸæŸ“åŠ›ãŒä¸Šæ˜‡ã—ã¾ã—ãŸã€‚å¯¾ç­–ã‚’æ€¥ã„ã§ã€‚");
      } else if(r < 0.3){
        // international aid
        resources += 6 + Math.floor(Math.random()*6);
        addLog("âœˆï¸ å›½éš›æ”¯æ´ãŒåˆ°ç€ã€‚è³‡æºã‚’å…¥æ‰‹ã—ã¾ã—ãŸã€‚");
      } else if(r < 0.45){
        // misinformation event reduces effectiveness temporarily
        if(!infoActive && Math.random()<0.6){
          spreadRate *= 1.12;
          addLog("ğŸ“µ ãƒ‡ãƒæ‹¡æ•£ï¼šå¯¾ç­–ã®åŠ¹æœãŒä¸€æ™‚çš„ã«ä¸‹ãŒã‚Šã¾ã—ãŸã€‚æƒ…å ±å¯¾ç­–ã‚’ã€‚");
        } else {
          addLog("â„¹ï¸ æƒ…å ±å…±æœ‰ãŒã†ã¾ãã„ãã€å”åŠ›ãŒåºƒãŒã‚Šã¾ã—ãŸã€‚");
        }
      } else if(r < 0.6){
        // vaccine breakthrough: slightly accelerate research
        researchRate += 0.25;
        addLog("ğŸ”¬ ç ”ç©¶ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¹ãƒ«ãƒ¼ç™ºç”Ÿã€ç ”ç©¶é€Ÿåº¦ãŒã‚ãšã‹ã«ä¸Šæ˜‡ã€‚");
      } else {
        // neutral minor event
        addLog("ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–°ï¼šç¾åœ°çŠ¶æ³ã«å¤‰åŒ–ãªã—ã€‚");
      }
    }

    // ---------- effects handling ----------
    function handleEffects(){
      // research boost effect expiration
      if(effects.researchBoost > 0){
        effects.researchBoost--;
        if(effects.researchBoost === 0){
          researchRate = Math.max(0.3, researchRate - 1.5); // revert temporary boost
          addLog("ãƒ¯ã‚¯ãƒãƒ³ç ”ç©¶ã®å³åŠ¹ãƒ–ãƒ¼ã‚¹ãƒˆãŒçµ‚äº†ã€‚ç¶™ç¶šçš„ãªæŠ•è³‡ãŒå¿…è¦ã§ã™ã€‚");
        }
      }

      // lockdown duration
      if(effects.lockdown > 0){
        effects.lockdown--;
        if(effects.lockdown === 0){
          // revert part of spreadRate back (approx)
          spreadRate /= 0.85;
          addLog("ãƒ­ãƒƒã‚¯ãƒ€ã‚¦ãƒ³ãŒè§£é™¤ã•ã‚Œã€ç§»å‹•åˆ¶é™ãŒç·©å’Œã•ã‚Œã¾ã—ãŸã€‚");
        }
      }

      // medical duration
      if(effects.medical > 0){
        effects.medical--;
        if(effects.medical === 0){
          baseDeathRate /= 0.7;
          baseHealRate /= 1.4;
          addLog("åŒ»ç™‚æ”¯æ´åŠ¹æœãŒå¾ã€…ã«æ¸›å°‘ã—ã¾ã—ãŸã€‚");
        }
      }

      // info duration: no direct numeric change but reduces chance of negative events while active
      if(effects.info > 0){
        effects.info--;
        if(effects.info === 0){
          addLog("æƒ…å ±ç™ºä¿¡ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®åŠ¹æœãŒè½ã¡ç€ãã¾ã—ãŸã€‚");
        }
      }
    }

    // ---------- å‹æ•—åˆ¤å®š ----------
    function checkWinLose(){
      // win: æ„ŸæŸ“è€…ãŒã»ã¼ã‚¼ãƒ­ï¼ˆä¸€å®šä»¥ä¸‹ï¼‰ã‹ã¤ãƒ¯ã‚¯ãƒãƒ³ä½¿ç”¨æ¸ˆã¿ã§åæŸå‚¾å‘
      if(!gameOver && infected < 1000 && vaccineUsed){
        addLog("ğŸ† æ„ŸæŸ“ã¯ã»ã¼åæŸã—ã¾ã—ãŸã€‚å‹åˆ©ï¼šä¸–ç•Œã¯å®ˆã‚‰ã‚Œã¾ã—ãŸï¼");
        gameOver = true;
        running = false;
      }
      // lose: æ„ŸæŸ“ãŒä¸–ç•Œäººå£ã®50%ä»¥ä¸Š
      if(!gameOver && (infected + recovered + dead) > worldPop * 0.5){
        addLog("ğŸ’€ è‡´å‘½çš„ï¼šæ„ŸæŸ“ãŒä¸–ç•Œã®åŠæ•°ã‚’è¶…ãˆã¾ã—ãŸã€‚æ•—åŒ—ã§ã™ã€‚");
        gameOver = true;
        running = false;
      }
      updateUI();
    }

    // ---------- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ç®¡ç† ----------
    function startTicker(){
      if(ticker) clearInterval(ticker);
      ticker = setInterval(tick, tickMs);
    }
    function restartTicker(){
      if(ticker) clearInterval(ticker);
      ticker = setInterval(tick, tickMs);
    }

    // ---------- åˆæœŸåŒ–ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰ ----------
    function init(){
      infected = 100000;
      recovered = 0;
      dead = 0;
      vaccineProgress = 0;
      resources = 15;
      spreadRate = 1.03;
      baseHealRate = 0.01;
      baseDeathRate = 0.001;
      researchRate = 0.5;
      vaccineUsed = false;
      gameOver = false;
      running = true;
      for(const k in cooldowns) cooldowns[k]=0;
      effects = { lockdown:0, medical:0, info:0 };
      logEl.innerHTML = '';
      addLog("ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚");
      updateUI();
    }

    // ---------- åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ----------
    init();
    startTicker();

    // safety: update UI periodically even if no tick (for buttons)
    setInterval(updateUI, 500);

    // expose some functions for debugging in console (optional)
    window.__pd = { state: ()=>({infected, recovered, dead, vaccineProgress, resources, spreadRate}), addLog };

  </script>
</body>
</html>
